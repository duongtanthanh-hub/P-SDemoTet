<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>P/S Tet Family Moment Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.0"
      }
    }
    </script>
</head>
  <body class="bg-red-900 text-white">
    <div id="root"></div>
    <script type="text/babel" data-type="module" data-presets="react,typescript">
      // In-browser build to resolve deployment issues on static hosts.

      // Polyfill 'process' to prevent "process is not defined" errors.
      window.process = window.process || { env: {} };

      import React, { useState, useEffect, useCallback, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI, Modality } from "@google/genai";

      // --- START services/geminiService.ts ---
      
      const API_KEY = 'AIzaSyDaaXh_7YDdiqDIElqk1EPaPZeuk01ecTE';

      const fileToBase64 = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve((reader.result).split(',')[1]);
          reader.onerror = error => reject(error);
        });
      };
      
      const generateFamilyImage = async (files) => {
        const ai = new GoogleGenAI({ apiKey: API_KEY });
      
        const imageParts = await Promise.all(
          files.map(async (file) => {
            const base64Data = await fileToBase64(file);
            return {
              inlineData: {
                data: base64Data,
                mimeType: file.type,
              },
            };
          })
        );
      
        const prompt = `Create a new, single, photorealistic composite image featuring the people from the uploaded photos.

**Primary Objective:** Preserve the exact facial likeness of each person. It is absolutely critical that their faces, hair, and unique features look identical to the source photos. Do not generate new faces or alter their appearances.

**Scene Details:**
- The family should be gathered happily around a table, enjoying a festive Tet meal together.
- Dress all family members in beautiful, traditional Vietnamese Ao Dai outfits in vibrant Tet colors (red, gold, etc.).
- The overall atmosphere must be joyful, warm, and celebratory.
- The final image should be a seamless and believable composition.

**Branding:**
- Subtly integrate a simple, elegant 'P/S' logo in the bottom right corner.

The final output must be a single, high-quality image that accurately represents the people provided.`;
      
        const response = await ai.models.generateContent({
          model: 'gemini-2.5-flash-image',
          contents: {
            parts: [
              { text: prompt },
              ...imageParts,
            ],
          },
          config: {
            responseModalities: [Modality.IMAGE],
          },
        });
      
        const firstPart = response.candidates?.[0]?.content?.parts[0];
        if (firstPart && 'inlineData' in firstPart && firstPart.inlineData) {
          return firstPart.inlineData.data;
        }
      
        throw new Error("No image data returned from the API.");
      };
      
      const generateFamilyVideo = async (imageBase64) => {
          const ai = new GoogleGenAI({ apiKey: API_KEY });
      
          const prompt = `An 8-second animated video based on the provided image of a family celebrating Tet. The family members should show subtle, realistic motion: gently laughing, smiling, and interacting warmly with each other while enjoying their meal. The atmosphere is festive and joyful. Include a background of gentle, happy Tet music and soft ambient sounds of a family gathering. Towards the very end of the video (last 2 seconds), apply a magical, noticeable sparkling effect to everyone's teeth to highlight their bright smiles. A 'P/S' logo should be visible in the bottom right corner throughout the video.`;
      
          let operation = await ai.models.generateVideos({
              model: 'veo-3.1-fast-generate-preview',
              prompt: prompt,
              image: {
                  imageBytes: imageBase64,
                  mimeType: 'image/png',
              },
              config: {
                  numberOfVideos: 1,
                  resolution: '720p',
                  aspectRatio: '16:9',
              },
          });
      
          while (!operation.done) {
              await new Promise(resolve => setTimeout(resolve, 10000));
              operation = await ai.operations.getVideosOperation({ operation: operation });
          }
          
          if (operation.error) {
              throw new Error(`Video generation failed: ${operation.error.message} (Code: ${operation.error.code})`);
          }
      
          const downloadLink = operation.response?.generatedVideos?.[0]?.video?.uri;
          if (!downloadLink) {
              throw new Error("Video generation completed, but no download link was found.");
          }
      
          const videoResponse = await fetch(`${downloadLink}&key=${API_KEY}`);
          if (!videoResponse.ok) {
              const errorText = await videoResponse.text();
              throw new Error(`Failed to download the generated video. Status: ${videoResponse.status}. Details: ${errorText}`);
          }
      
          const videoBlob = await videoResponse.blob();
          return URL.createObjectURL(videoBlob);
      };

      // --- END services/geminiService.ts ---

      // --- START components/Loader.tsx ---
      const Loader = ({ text }) => {
        return (
          <div className="flex flex-col items-center justify-center gap-4 my-8 animate-fade-in">
            <svg className="animate-spin h-12 w-12 text-yellow-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p className="text-lg text-yellow-100 font-medium">{text}</p>
          </div>
        );
      };
      // --- END components/Loader.tsx ---

      // --- START components/FileUpload.tsx ---
      const FileUpload = ({ onFilesChange }) => {
        const [previews, setPreviews] = useState([]);
        const [dragActive, setDragActive] = useState(false);
        const fileInputRef = useRef(null);
      
        const handleFiles = useCallback((files) => {
          if (!files) return;
      
          const MAX_FILES = 5;
          const selectedFiles = Array.from(files).slice(0, MAX_FILES);
          onFilesChange(selectedFiles);
      
          const newPreviews = selectedFiles.map(file => URL.createObjectURL(file));
          
          previews.forEach(url => URL.revokeObjectURL(url));
          setPreviews(newPreviews);
        }, [onFilesChange, previews]);
      
        const handleDrag = useCallback((e) => {
          e.preventDefault();
          e.stopPropagation();
          if (e.type === "dragenter" || e.type === "dragover") {
            setDragActive(true);
          } else if (e.type === "dragleave") {
            setDragActive(false);
          }
        }, []);
      
        const handleDrop = useCallback((e) => {
          e.preventDefault();
          e.stopPropagation();
          setDragActive(false);
          if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            handleFiles(e.dataTransfer.files);
            // Sync the dropped files with the file input
            fileInputRef.current.files = e.dataTransfer.files;
          }
        }, [handleFiles]);
      
        const handleChange = (e) => {
          e.preventDefault();
          handleFiles(e.target.files);
        };
      
        const removeFile = (indexToRemove) => {
            const newPreviews = previews.filter((_, index) => index !== indexToRemove);
            const newFiles = Array.from(fileInputRef.current.files).filter((_, index) => index !== indexToRemove);

            const dataTransfer = new DataTransfer();
            newFiles.forEach(file => dataTransfer.items.add(file));
            fileInputRef.current.files = dataTransfer.files;

            onFilesChange(newFiles);
            setPreviews(newPreviews);
        };

        return (
          <div className="w-full space-y-4">
            <label
              htmlFor="file-upload-input"
              className={`relative flex flex-col items-center justify-center w-full h-48 border-2 border-dashed rounded-lg cursor-pointer transition-colors duration-300 ${dragActive ? 'border-yellow-400 bg-white/20' : 'border-yellow-200/50 hover:border-yellow-300 hover:bg-white/10'}`}
              onDragEnter={handleDrag}
              onDragOver={handleDrag}
              onDragLeave={handleDrag}
              onDrop={handleDrop}
            >
              <div className="flex flex-col items-center justify-center pt-5 pb-6">
                <svg className="w-10 h-10 mb-3 text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                <p className="mb-2 text-sm text-yellow-100"><span className="font-semibold">Click to upload</span> or drag and drop</p>
                <p className="text-xs text-yellow-200/80">Upload up to 5 portrait photos</p>
              </div>
              <input ref={fileInputRef} id="file-upload-input" type="file" className="hidden" multiple accept="image/*" onChange={handleChange} />
            </label>
      
            {previews.length > 0 && (
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                {previews.map((src, index) => (
                  <div key={index} className="relative group">
                    <img src={src} alt={`Preview ${index + 1}`} className="w-full h-32 object-cover rounded-lg shadow-md" />
                    <button
                      onClick={() => removeFile(index)}
                      className="absolute top-1 right-1 bg-red-600/80 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                    >
                      X
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      };
      // --- END components/FileUpload.tsx ---

      // --- START App.tsx ---
      function App() {
        const [files, setFiles] = useState([]);
        const [generatedImage, setGeneratedImage] = useState(null);
        const [generatedVideoUrl, setGeneratedVideoUrl] = useState(null);
        const [isLoadingImage, setIsLoadingImage] = useState(false);
        const [isLoadingVideo, setIsLoadingVideo] = useState(false);
        const [videoMessageIndex, setVideoMessageIndex] = useState(0);
        const [error, setError] = useState(null);

        const PsLogo = ({ className }) => (
          <div className={`font-bold text-4xl lg:text-5xl ${className}`}>
            <span className="text-blue-800">P</span>
            <span className="text-blue-800">/</span>
            <span className="text-blue-800">S</span>
          </div>
        );

        const videoLoadingMessages = [
          "Gathering the Tet decorations...",
          "Setting the festive table...",
          "Animating your family's smiles...",
          "Adding the final sparkle...",
          "This can take a few minutes...",
        ];
      
        useEffect(() => {
          let interval;
          if (isLoadingVideo) {
            interval = window.setInterval(() => {
              setVideoMessageIndex((prevIndex) => (prevIndex + 1) % videoLoadingMessages.length);
            }, 3000);
          }
          return () => clearInterval(interval);
        }, [isLoadingVideo]);

        const handleFilesChange = (selectedFiles) => {
          setError(null);
          setGeneratedImage(null);
          setGeneratedVideoUrl(null);
          setFiles(selectedFiles);
        };
      
        const handleGenerateImage = useCallback(async () => {
          if (files.length === 0) {
            setError("Please upload at least one photo.");
            return;
          }

          setIsLoadingImage(true);
          setError(null);
          setGeneratedImage(null);
          setGeneratedVideoUrl(null);
      
          try {
            const imageB64 = await generateFamilyImage(files);
            setGeneratedImage(`data:image/png;base64,${imageB64}`);
          } catch (err) {
            console.error("Image generation failed:", err);
            let errorMessage = `Failed to generate the family image: ${err.message}. Please check the console for details.`;
            setError(errorMessage);
          } finally {
            setIsLoadingImage(false);
          }
        }, [files]);
      
        const handleGenerateVideo = useCallback(async () => {
          if (!generatedImage) return;

          setIsLoadingVideo(true);
          setError(null);
          setGeneratedVideoUrl(null);
          setVideoMessageIndex(0);
      
          try {
            const videoUrl = await generateFamilyVideo(generatedImage.split(',')[1]);
            setGeneratedVideoUrl(videoUrl);
          } catch (err) {
              console.error("Video generation failed:", err);
              let errorMessage = `Failed to generate the video: ${err.message}. Please try again.`;
              setError(errorMessage);
          } finally {
            setIsLoadingVideo(false);
          }
        }, [generatedImage]);
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-red-800 to-yellow-600 p-4 sm:p-6 lg:p-8 font-sans">
            <main className="max-w-4xl mx-auto bg-white/10 backdrop-blur-md rounded-2xl shadow-2xl p-6 sm:p-8 space-y-8">
              <header className="text-center space-y-4">
                <div className="flex justify-center items-center gap-4">
                   <PsLogo />
                   <h1 className="text-3xl sm:text-4xl lg:text-5xl font-bold text-yellow-300 tracking-tight">
                      Tet Family Moment
                   </h1>
                </div>
                <p className="text-yellow-100 max-w-2xl mx-auto">
                  Upload up to 5 photos of your family members to create a beautiful Tet portrait, then bring it to life with a magical animated video!
                </p>
              </header>
      
              {error && (
                <div className="bg-red-500/80 border border-red-700 text-white px-4 py-3 rounded-lg relative" role="alert">
                  <strong className="font-bold">Oops! </strong>
                  <span className="block sm:inline">{error}</span>
                </div>
              )}
      
              <div className="bg-white/10 p-6 rounded-xl space-y-6">
                <h2 className="text-2xl font-semibold text-yellow-200 border-b-2 border-yellow-400/50 pb-2">Step 1: Create Your Family Portrait</h2>
                <FileUpload onFilesChange={handleFilesChange} />
                <div className="text-center">
                  <button
                    onClick={handleGenerateImage}
                    disabled={files.length === 0 || isLoadingImage || isLoadingVideo}
                    className="px-8 py-3 bg-yellow-400 text-red-900 font-bold rounded-full shadow-lg hover:bg-yellow-300 transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed transform hover:scale-105 disabled:scale-100"
                  >
                    {isLoadingImage ? 'Creating Portrait...' : 'Generate Photo'}
                  </button>
                </div>
              </div>
      
              {isLoadingImage && <Loader text="Generating your family portrait..." />}
      
              {generatedImage && (
                <div className="bg-white/10 p-6 rounded-xl space-y-6 animate-fade-in">
                   <h2 className="text-2xl font-semibold text-yellow-200 border-b-2 border-yellow-400/50 pb-2">Step 2: Bring Your Portrait to Life</h2>
                  <img src={generatedImage} alt="Generated family portrait" className="rounded-lg shadow-md w-full max-w-xl mx-auto"/>
                   <div className="text-center">
                      <button
                          onClick={handleGenerateVideo}
                          disabled={isLoadingVideo}
                          className="px-8 py-3 bg-blue-500 text-white font-bold rounded-full shadow-lg hover:bg-blue-400 transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed transform hover:scale-105 disabled:scale-100"
                      >
                          {isLoadingVideo ? 'Creating Video...' : 'Generate 8s Video'}
                      </button>
                   </div>
                </div>
              )}
      
              {isLoadingVideo && <Loader text={videoLoadingMessages[videoMessageIndex]} />}
              
              {generatedVideoUrl && (
                <div className="bg-white/10 p-6 rounded-xl space-y-4 animate-fade-in">
                  <h2 className="text-2xl font-semibold text-yellow-200 text-center">Your Tet Family Moment is Ready!</h2>
                  <video controls autoPlay loop src={generatedVideoUrl} className="w-full max-w-xl mx-auto rounded-lg shadow-md"></video>
                  <div className="text-center">
                      <a
                        href={generatedVideoUrl}
                        download="ps-tet-family-moment.mp4"
                        className="inline-block mt-4 px-8 py-3 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-400 transition-all duration-300 transform hover:scale-105"
                      >
                        Download Video
                      </a>
                  </div>
                </div>
              )}
      
              <footer className="text-center text-yellow-200/70 text-sm pt-4">
                A P/S Tet Celebration powered by Google AI.
              </footer>
            </main>
          </div>
        );
      }
      // --- END App.tsx ---
      
      // --- START index.tsx ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }
      
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
      // --- END index.tsx ---
    </script>
  </body>
</html>